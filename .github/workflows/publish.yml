name: Publish (npm Trusted Publishing)

on:
    push:
        tags: ["v*"] # e.g. v1.2.3

permissions:
    id-token: write # required for OIDC
    contents: read

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  registry-url: "https://registry.npmjs.org"
            # Ensure npm has OIDC support (required by npm Trusted Publishing)
            - run: npm -v && npm install -g npm@latest
            - run: npm ci
            - run: npm test --if-present
            # For first-time scoped publish, add --access public
            - run: npm publish
